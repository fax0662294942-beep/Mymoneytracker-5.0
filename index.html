<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MoneyTracker - Gestione Spese</title>
    <link rel="manifest" href="manifest.json">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .app-container {
            max-width: 100%;
            min-height: 100vh;
            background: white;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .balance-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            margin: -10px 20px 20px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 5px 0;
        }
        
        .balance-label {
            color: #666;
            font-size: 13px;
        }
        
        .period-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0 10px 0;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .stat-box {
            padding: 8px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-box.income {
            background: #e8f5e9;
        }
        
        .stat-box.expense {
            background: #ffebee;
        }
        
        .stat-box.neutral {
            background: #e3f2fd;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: bold;
        }
        
        .stat-value.income {
            color: #4caf50;
        }
        
        .stat-value.expense {
            color: #f44336;
        }
        
        .stat-value.neutral {
            color: #2196F3;
        }
        
        /* NUOVO: Dashboard con grafico centrale */
        .dashboard-container {
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .chart-center-container {
            position: relative;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .chart-center-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }
        
        .chart-center-label {
            font-size: 14px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .chart-center-amount {
            font-size: 28px;
            font-weight: bold;
            color: #f44336;
            margin-bottom: 3px;
        }
        
        .chart-center-budget {
            font-size: 14px;
            color: #4CAF50;
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
            padding: 0 10px;
        }
        
        .category-card {
            text-align: center;
            cursor: move;
            transition: all 0.3s;
            padding: 5px;
            border-radius: 10px;
        }
        
        .category-card:active {
            transform: scale(1.05);
            background: rgba(102, 126, 234, 0.1);
        }
        
        .category-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 8px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .category-amount {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .category-name-small {
            font-size: 10px;
            color: #666;
            line-height: 1.2;
        }
        
        /* Sezione superiore con mini box */
        .top-boxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .top-box {
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .top-box-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .top-box-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: none;
            font-size: 14px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            font-weight: 600;
        }
        
        .content {
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .transaction-list {
            list-style: none;
        }
        
        .transaction-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }
        
        .transaction-info {
            flex: 1;
        }
        
        .transaction-category {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .transaction-date {
            font-size: 12px;
            color: #999;
        }
        
        .transaction-amount {
            font-size: 18px;
            font-weight: bold;
        }
        
        .transaction-amount.expense {
            color: #f44336;
        }
        
        .transaction-amount.income {
            color: #4caf50;
        }
        
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 100;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @keyframes menuAppear {
            from { 
                opacity: 0;
                transform: translateX(-50%) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateX(-50%) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .type-btn.active.expense {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
        
        .type-btn.active.income {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-btn {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .category-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .category-name {
            font-size: 12px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:active {
            transform: scale(0.98);
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            border: none;
            background: none;
            color: #999;
            transition: color 0.3s;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 3px;
        }
        
        .nav-label {
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Categorie predefinite (espanse come l'app dell'utente)
        const CATEGORIES = {
            expense: [
                { id: 'food', name: 'Spesa', icon: 'ðŸ›’', color: '#FF6B6B' },
                { id: 'restaurant', name: 'Ristoranti', icon: 'ðŸ•', color: '#FF8E8E' },
                { id: 'transport', name: 'Trasporti', icon: 'ðŸš—', color: '#4ECDC4' },
                { id: 'fuel', name: 'Carburante', icon: 'â›½', color: '#5ED5D5' },
                { id: 'bills', name: 'Bollette', icon: 'ðŸ’¡', color: '#4DA6FF' },
                { id: 'rent', name: 'Affitto', icon: 'ðŸ ', color: '#3D8BFF' },
                { id: 'shopping', name: 'Shopping', icon: 'ðŸ›ï¸', color: '#95E1D3' },
                { id: 'health', name: 'Salute', icon: 'âš•ï¸', color: '#AA96DA' },
                { id: 'entertainment', name: 'Svago', icon: 'ðŸŽ¬', color: '#FCBAD3' },
                { id: 'travel', name: 'Viaggi', icon: 'âœˆï¸', color: '#FFD93D' },
                { id: 'vacation', name: 'Vacanze', icon: 'ðŸ–ï¸', color: '#FFF176' },
                { id: 'education', name: 'Istruzione', icon: 'ðŸ“š', color: '#A8D8EA' },
                { id: 'work', name: 'Per Lavoro', icon: 'ðŸ’¼', color: '#8D6E63' },
                { id: 'family', name: 'Famiglia', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', color: '#CE93D8' },
                { id: 'personal', name: 'Spese Personali', icon: 'ðŸ˜Š', color: '#FFB74D' },
                { id: 'other', name: 'Altro', icon: 'ðŸ“¦', color: '#B0BEC5' }
            ],
            income: [
                { id: 'salary', name: 'Stipendio', icon: 'ðŸ’¼', color: '#6BCF7F' },
                { id: 'freelance', name: 'Freelance', icon: 'ðŸ’»', color: '#4CAF50' },
                { id: 'investment', name: 'Investimenti', icon: 'ðŸ“ˆ', color: '#8BC34A' },
                { id: 'refund', name: 'Rimborsi', icon: 'ðŸ’³', color: '#9CCC65' },
                { id: 'gift', name: 'Regalo', icon: 'ðŸŽ', color: '#AED581' },
                { id: 'other', name: 'Altro', icon: 'ðŸ’°', color: '#C5E1A5' }
            ]
        };

        // Conti disponibili
        const ACCOUNTS = [
            { id: 'all', name: 'Tutti i Conti', icon: 'ðŸ’°', color: '#667eea' },
            { id: 'cash', name: 'Contanti', icon: 'ðŸ’µ', color: '#4CAF50' },
            { id: 'card', name: 'Carta', icon: 'ðŸ’³', color: '#2196F3' },
            { id: 'bank', name: 'Conto Corrente', icon: 'ðŸ¦', color: '#FF9800' },
            { id: 'savings', name: 'Risparmi', icon: 'ðŸ·', color: '#E91E63' }
        ];

        function App() {
            // ============ ACCOUNT MULTIPLI ============
            const [accounts, setAccounts] = useState([]);
            const [activeAccountId, setActiveAccountId] = useState(null);
            const [showAccountModal, setShowAccountModal] = useState(false);
            const [showTransferModal, setShowTransferModal] = useState(false);
            const [transfersOnlyFilter, setTransfersOnlyFilter] = useState(false);
            
            // ============ DATI ACCOUNT CORRENTE ============
            const [transactions, setTransactions] = useState([]);
            const [budgets, setBudgets] = useState({});
            const [settings, setSettings] = useState({
                monthStartDay: 1, // Giorno di inizio mese (1-31)
                weekStartDay: 1,  // 1 = LunedÃ¬, 0 = Domenica
                defaultAccount: 'all'
            });
            const [selectedAccount, setSelectedAccount] = useState('all');
            const [viewMode, setViewMode] = useState('month'); // 'month', 'year', 'week', 'custom'
            const [periodOffset, setPeriodOffset] = useState(0); // 0 = periodo corrente, -1 = precedente, +1 = successivo
            const [customDateRange, setCustomDateRange] = useState({ start: null, end: null });
            const [showModal, setShowModal] = useState(false);
            const [showBudgetModal, setShowBudgetModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showCategoryMenu, setShowCategoryMenu] = useState(null); // {categoryId, x, y}
            const [showEditCategoryModal, setShowEditCategoryModal] = useState(null); // categoryId
            const [categoryFilter, setCategoryFilter] = useState(null); // per filtrare transazioni
            const [activeTab, setActiveTab] = useState('transactions');
            const [currentPage, setCurrentPage] = useState('categories');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const trendChartRef = useRef(null);
            const trendChartInstance = useRef(null);

            // ============ INIT ACCOUNT ============
            useEffect(() => {
                // Carica o crea account
                const savedAccounts = localStorage.getItem('moneyTrackerAccounts');
                if (savedAccounts) {
                    const parsed = JSON.parse(savedAccounts);
                    setAccounts(parsed);
                    const savedActiveId = localStorage.getItem('moneyTrackerActiveAccount');
                    setActiveAccountId(savedActiveId || parsed[0]?.id);
                } else {
                    // Migra dati esistenti â†’ account famiglia + crea personale
                    const oldTransactions = localStorage.getItem('moneyTrackerData');
                    const oldBudgets = localStorage.getItem('moneyTrackerBudgets');
                    const oldSettings = localStorage.getItem('moneyTrackerSettings');
                    
                    const defaultAccounts = [
                        { id: 'famiglia', name: 'Spese Famiglia', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', color: '#9C27B0' },
                        { id: 'personale', name: 'Spese Personali', icon: 'ðŸ˜Š', color: '#FF9800' }
                    ];
                    
                    setAccounts(defaultAccounts);
                    setActiveAccountId('famiglia');
                    localStorage.setItem('moneyTrackerAccounts', JSON.stringify(defaultAccounts));
                    localStorage.setItem('moneyTrackerActiveAccount', 'famiglia');
                    
                    // Migra dati esistenti in famiglia
                    if (oldTransactions) localStorage.setItem('account_famiglia_transactions', oldTransactions);
                    if (oldBudgets) localStorage.setItem('account_famiglia_budgets', oldBudgets);
                    if (oldSettings) localStorage.setItem('account_famiglia_settings', oldSettings);
                }
            }, []);

            // ============ CARICA DATI ACCOUNT ATTIVO ============
            useEffect(() => {
                if (!activeAccountId) return;
                
                const prefix = `account_${activeAccountId}_`;
                const savedTransactions = localStorage.getItem(prefix + 'transactions');
                const savedBudgets = localStorage.getItem(prefix + 'budgets');
                const savedSettings = localStorage.getItem(prefix + 'settings');
                
                setTransactions(savedTransactions ? JSON.parse(savedTransactions) : []);
                setBudgets(savedBudgets ? JSON.parse(savedBudgets) : {});
                setSettings(savedSettings ? JSON.parse(savedSettings) : {
                    monthStartDay: 1,
                    weekStartDay: 1,
                    defaultAccount: 'all'
                });
                
                // Reset filtri
                setCategoryFilter(null);
                setTransfersOnlyFilter(false);
                setSelectedAccount('all');
            }, [activeAccountId]);

            // ============ SALVA DATI ACCOUNT ATTIVO ============
            useEffect(() => {
                if (!activeAccountId) return;
                const prefix = `account_${activeAccountId}_`;
                localStorage.setItem(prefix + 'transactions', JSON.stringify(transactions));
            }, [transactions, activeAccountId]);

            useEffect(() => {
                if (!activeAccountId) return;
                const prefix = `account_${activeAccountId}_`;
                localStorage.setItem(prefix + 'budgets', JSON.stringify(budgets));
            }, [budgets, activeAccountId]);

            useEffect(() => {
                if (!activeAccountId) return;
                const prefix = `account_${activeAccountId}_`;
                localStorage.setItem(prefix + 'settings', JSON.stringify(settings));
            }, [settings, activeAccountId]);

            // Funzione per ottenere le date del periodo in base a viewMode e offset
            const getPeriodDates = () => {
                const today = new Date();
                let startDate, endDate;
                
                if (viewMode === 'custom' && customDateRange.start && customDateRange.end) {
                    return {
                        startDate: new Date(customDateRange.start),
                        endDate: new Date(customDateRange.end)
                    };
                }
                
                if (viewMode === 'year') {
                    // Anno solare con offset
                    const year = today.getFullYear() + periodOffset;
                    startDate = new Date(year, 0, 1); // 1 gennaio
                    endDate = new Date(year, 11, 31, 23, 59, 59, 999); // 31 dicembre
                } else if (viewMode === 'week') {
                    // Settimana dal lunedÃ¬
                    const currentDay = today.getDay();
                    const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // LunedÃ¬ = 0
                    
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - daysFromMonday + (periodOffset * 7));
                    startDate.setHours(0, 0, 0, 0);
                    
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                } else {
                    // Mese personalizzato (default)
                    const startDay = settings.monthStartDay;
                    
                    // Calcola il mese con offset
                    let targetDate = new Date(today);
                    targetDate.setMonth(today.getMonth() + periodOffset);
                    
                    if (targetDate.getDate() >= startDay) {
                        startDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), startDay);
                        endDate = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, startDay - 1);
                    } else {
                        startDate = new Date(targetDate.getFullYear(), targetDate.getMonth() - 1, startDay);
                        endDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), startDay - 1);
                    }
                }
                
                endDate.setHours(23, 59, 59, 999);
                return { startDate, endDate };
            };

            // Funzione per ottenere le date del periodo personalizzato (deprecata, usa getPeriodDates)
            const getCustomMonthDates = () => {
                return getPeriodDates();
            };

            // Filtra transazioni per conto
            const getFilteredTransactions = () => {
                if (selectedAccount === 'all') {
                    return transactions;
                }
                return transactions.filter(t => t.account === selectedAccount);
            };

            // Calcoli con filtro conto
            const filteredTransactions = getFilteredTransactions();
            
            const balance = filteredTransactions.reduce((acc, t) => 
                acc + (t.type === 'income' ? t.amount : -t.amount), 0
            );
            
            const totalIncome = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((acc, t) => acc + t.amount, 0);
            
            const totalExpense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => acc + t.amount, 0);

            // Calcoli mensili con periodo personalizzato
            const getCurrentMonthTransactions = () => {
                const { startDate, endDate } = getPeriodDates();
                
                return filteredTransactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= startDate && tDate <= endDate;
                });
            };

            // Funzioni di navigazione periodo
            const goToPreviousPeriod = () => {
                setPeriodOffset(periodOffset - 1);
            };

            const goToNextPeriod = () => {
                setPeriodOffset(periodOffset + 1);
            };

            const goToCurrentPeriod = () => {
                setPeriodOffset(0);
            };

            // Formatta il periodo per visualizzazione
            const formatPeriodDisplay = () => {
                const { startDate, endDate } = getPeriodDates();
                
                if (viewMode === 'year') {
                    return startDate.getFullYear().toString();
                } else if (viewMode === 'week') {
                    return `${startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })} - ${endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                } else if (viewMode === 'custom') {
                    return `${startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })} - ${endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                } else {
                    // Mese personalizzato
                    return `${startDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })} - ${endDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' })}`;
                }
            };

            const getMonthlyExpensesByCategory = () => {
                const monthlyTransactions = getCurrentMonthTransactions();
                const expenses = {};
                
                monthlyTransactions
                    .filter(t => t.type === 'expense')
                    .forEach(t => {
                        if (!expenses[t.category]) {
                            expenses[t.category] = 0;
                        }
                        expenses[t.category] += t.amount;
                    });
                
                return expenses;
            };

            const addTransaction = (transaction) => {
                setTransactions([transaction, ...transactions]);
                setShowModal(false);
            };

            const deleteTransaction = (id) => {
                if (window.confirm('Sei sicuro di voler eliminare questa transazione?')) {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            };

            const setBudget = (category, amount) => {
                setBudgets({ ...budgets, [category]: parseFloat(amount) });
            };

            const updateSettings = (newSettings) => {
                setSettings({ ...settings, ...newSettings });
                setShowSettingsModal(false);
            };

            // ============ GESTIONE ACCOUNT ============
            const switchAccount = (accountId) => {
                setActiveAccountId(accountId);
                localStorage.setItem('moneyTrackerActiveAccount', accountId);
                setCurrentPage('categories'); // Torna a home quando cambi account
            };

            const getActiveAccount = () => {
                return accounts.find(a => a.id === activeAccountId);
            };

            const createAccount = (accountData) => {
                const newAccount = {
                    id: 'account_' + Date.now(),
                    ...accountData
                };
                const updated = [...accounts, newAccount];
                setAccounts(updated);
                localStorage.setItem('moneyTrackerAccounts', JSON.stringify(updated));
                return newAccount;
            };

            const updateAccount = (accountId, newData) => {
                const updated = accounts.map(a => a.id === accountId ? { ...a, ...newData } : a);
                setAccounts(updated);
                localStorage.setItem('moneyTrackerAccounts', JSON.stringify(updated));
            };

            const deleteAccount = (accountId) => {
                if (accounts.length <= 1) {
                    alert('Non puoi eliminare l\'ultimo account!');
                    return;
                }
                if (!window.confirm('Sei sicuro? Tutti i dati di questo account verranno eliminati!')) return;
                
                // Rimuovi dati account
                const prefix = `account_${accountId}_`;
                localStorage.removeItem(prefix + 'transactions');
                localStorage.removeItem(prefix + 'budgets');
                localStorage.removeItem(prefix + 'settings');
                localStorage.removeItem(prefix + 'categoryOrder');
                localStorage.removeItem(prefix + 'customCategories');
                
                // Rimuovi da lista
                const updated = accounts.filter(a => a.id !== accountId);
                setAccounts(updated);
                localStorage.setItem('moneyTrackerAccounts', JSON.stringify(updated));
                
                // Switch a primo account disponibile
                if (activeAccountId === accountId) {
                    switchAccount(updated[0].id);
                }
            };

            // ============ TRASFERIMENTI TRA ACCOUNT ============
            const createTransfer = (transferData) => {
                const { fromAccountId, toAccountId, amount, fromAccountType, toAccountType, note, date } = transferData;
                
                // Crea expense nell'account origine
                const expenseId = Date.now();
                const expense = {
                    id: expenseId,
                    type: 'expense',
                    amount: parseFloat(amount),
                    category: 'other',
                    account: fromAccountType,
                    note: `ðŸ”„ Trasferimento â†’ ${accounts.find(a => a.id === toAccountId)?.name || 'Account'} ${note ? '(' + note + ')' : ''}`,
                    date: date,
                    isTransfer: true,
                    transferId: expenseId,
                    linkedAccountId: toAccountId
                };
                
                // Crea income nell'account destinazione
                const income = {
                    id: expenseId + 1,
                    type: 'income',
                    amount: parseFloat(amount),
                    category: 'other',
                    account: toAccountType,
                    note: `ðŸ”„ Trasferimento â† ${accounts.find(a => a.id === fromAccountId)?.name || 'Account'} ${note ? '(' + note + ')' : ''}`,
                    date: date,
                    isTransfer: true,
                    transferId: expenseId,
                    linkedAccountId: fromAccountId
                };
                
                // Salva in entrambi gli account
                const fromPrefix = `account_${fromAccountId}_`;
                const toPrefix = `account_${toAccountId}_`;
                
                const fromTransactions = JSON.parse(localStorage.getItem(fromPrefix + 'transactions') || '[]');
                const toTransactions = JSON.parse(localStorage.getItem(toPrefix + 'transactions') || '[]');
                
                localStorage.setItem(fromPrefix + 'transactions', JSON.stringify([expense, ...fromTransactions]));
                localStorage.setItem(toPrefix + 'transactions', JSON.stringify([income, ...toTransactions]));
                
                // Ricarica se siamo in uno dei due account
                if (activeAccountId === fromAccountId || activeAccountId === toAccountId) {
                    const prefix = `account_${activeAccountId}_`;
                    const updated = JSON.parse(localStorage.getItem(prefix + 'transactions') || '[]');
                    setTransactions(updated);
                }
                
                setShowTransferModal(false);
                alert('âœ… Trasferimento completato!');
            };

            // IMPORT DA 1MONEY CSV
            const import1MoneyCSV = (csvText) => {
                try {
                    const lines = csvText.split('\n').filter(line => line.trim());
                    const header = lines[0];
                    
                    // Mapping categorie 1Money â†’ MoneyTracker
                    const categoryMapping = {
                        'Bollette': 'bills',
                        'Spesa': 'food',
                        'Carburante': 'fuel',
                        'Per Lavoro': 'work',
                        'Altro': 'other',
                        'Affitto': 'rent',
                        'polizze / rimessaggio': 'other',
                        'manutenzione': 'other',
                        'Fuori Budget': 'other',
                        'Rimborso': 'refund' // per entrate
                    };
                    
                    // Mapping conti 1Money â†’ MoneyTracker
                    const accountMapping = {
                        'Megliobanca': 'bank',
                        'Franco': 'cash',
                        'Conto': 'bank',
                        'Contanti': 'cash',
                        'buoni pasto Franco': 'card',
                        'buoni pasto Valentina': 'card',
                        'Valentina': 'cash',
                        'Vacanze': 'savings'
                    };
                    
                    const importedTransactions = [];
                    const skippedCount = { trasferimenti: 0, errori: 0 };
                    
                    for (let i = 1; i < lines.length; i++) {
                        try {
                            // Parse CSV manualmente (gestisce virgole dentro le virgolette)
                            const matches = lines[i].match(/("(?:[^"]|"")*"|[^,]*)(,|$)/g);
                            if (!matches || matches.length < 10) continue;
                            
                            const fields = matches.map(m => 
                                m.replace(/,$/, '').replace(/^"|"$/g, '').replace(/""/g, '"').trim()
                            );
                            
                            const [data, tipologia, dalConto, alContoCategoria, importo, valuta, , , , note] = fields;
                            
                            // Salta trasferimenti
                            if (tipologia === 'Trasferimento') {
                                skippedCount.trasferimenti++;
                                continue;
                            }
                            
                            // Parse data (formato gg/mm/aa)
                            const [giorno, mese, anno] = data.split('/');
                            const year = parseInt('20' + anno);
                            const dateObj = new Date(year, parseInt(mese) - 1, parseInt(giorno));
                            
                            // Estrai categoria principale (prima delle parentesi)
                            const categoriaMatch = alContoCategoria.match(/^([^(]+)/);
                            const categoriaPrincipale = categoriaMatch ? categoriaMatch[1].trim() : alContoCategoria;
                            
                            // Estrai sottocategoria (dentro parentesi)
                            const sottocategoriaMatch = alContoCategoria.match(/\(([^)]+)\)/);
                            const sottocategoria = sottocategoriaMatch ? sottocategoriaMatch[1].trim() : '';
                            
                            // Determina tipo
                            const type = tipologia === 'Entrata' ? 'income' : 'expense';
                            
                            // Mappa categoria
                            let categoryId = categoryMapping[categoriaPrincipale] || 'other';
                            
                            // Per entrate, controlla se Ã¨ rimborso
                            if (type === 'income') {
                                categoryId = categoriaPrincipale === 'Rimborso' ? 'refund' : 
                                            alContoCategoria.includes('Franco') || alContoCategoria.includes('Valentina') ? 'salary' : 
                                            'other';
                            }
                            
                            // Mappa conto
                            const accountId = accountMapping[dalConto] || 'cash';
                            
                            // Crea nota combinata
                            let finalNote = note || '';
                            if (sottocategoria && sottocategoria !== categoriaPrincipale) {
                                finalNote = sottocategoria + (note ? ' - ' + note : '');
                            }
                            
                            // Crea transazione
                            const transaction = {
                                id: Date.now() + i,
                                type: type,
                                amount: parseFloat(importo.replace(',', '.')),
                                category: categoryId,
                                account: accountId,
                                note: finalNote,
                                date: dateObj.toISOString()
                            };
                            
                            importedTransactions.push(transaction);
                            
                        } catch (err) {
                            console.error('Errore riga', i, err);
                            skippedCount.errori++;
                        }
                    }
                    
                    // Aggiungi transazioni importate
                    setTransactions([...importedTransactions, ...transactions]);
                    
                    return {
                        success: true,
                        imported: importedTransactions.length,
                        skipped: skippedCount
                    };
                    
                } catch (error) {
                    console.error('Errore import:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = import1MoneyCSV(e.target.result);
                    if (result.success) {
                        alert(`âœ… Import completato!\n\n` +
                              `ðŸ“¥ Importate: ${result.imported} transazioni\n` +
                              `â­ï¸ Trasferimenti saltati: ${result.skipped.trasferimenti}\n` +
                              `âŒ Errori: ${result.skipped.errori}\n\n` +
                              `Le tue transazioni sono state aggiunte!`);
                    } else {
                        alert(`âŒ Errore durante l'import:\n${result.error}`);
                    }
                };
                reader.readAsText(file);
            };

            // Gestione menu categoria
            const handleCategoryClick = (category, event) => {
                event.stopPropagation();
                const rect = event.currentTarget.getBoundingClientRect();
                setShowCategoryMenu({
                    categoryId: category.id,
                    category: category,
                    x: rect.left + rect.width / 2,
                    y: rect.bottom + 5
                });
            };

            const handleAddMovementFromCategory = (categoryId) => {
                setShowCategoryMenu(null);
                // Pre-compila il form con la categoria selezionata
                setShowModal({ preselectedCategory: categoryId });
            };

            const handleViewMovements = (categoryId) => {
                setShowCategoryMenu(null);
                setCategoryFilter(categoryId);
                setCurrentPage('home');
            };

            const handleEditCategory = (categoryId) => {
                setShowCategoryMenu(null);
                setShowEditCategoryModal(categoryId);
            };

            const updateCategory = (categoryId, newData) => {
                // Aggiorna la categoria nelle impostazioni personalizzate
                const customCategories = JSON.parse(localStorage.getItem('customCategories') || '{}');
                customCategories[categoryId] = {
                    ...CATEGORIES.expense.find(c => c.id === categoryId),
                    ...customData,
                    ...newData
                };
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
                setShowEditCategoryModal(null);
                // Ricarica la pagina per applicare le modifiche
                window.location.reload();
            };

            const exportToExcel = () => {
                let csv = 'Data,Tipo,Categoria,Conto,Importo,Note\n';
                
                filteredTransactions.forEach(t => {
                    const date = new Date(t.date).toLocaleDateString('it-IT');
                    const type = t.type === 'income' ? 'Entrata' : 'Uscita';
                    const cat = CATEGORIES[t.type].find(c => c.id === t.category);
                    const category = cat ? cat.name : t.category;
                    const acc = ACCOUNTS.find(a => a.id === (t.account || 'cash'));
                    const account = acc ? acc.name : 'Sconosciuto';
                    const amount = t.amount.toFixed(2);
                    const note = t.note || '';
                    
                    csv += `${date},${type},${category},${account},${amount},"${note}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `moneytracker_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Grafico spese per categoria
            useEffect(() => {
                if (currentPage === 'stats' && chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const expensesByCategory = getMonthlyExpensesByCategory();

                    const labels = Object.keys(expensesByCategory).map(catId => {
                        const cat = CATEGORIES.expense.find(c => c.id === catId);
                        return cat ? cat.name : catId;
                    });

                    const data = Object.values(expensesByCategory);
                    const colors = Object.keys(expensesByCategory).map(catId => {
                        const cat = CATEGORIES.expense.find(c => c.id === catId);
                        return cat ? cat.color : '#999';
                    });

                    if (data.length > 0) {
                        chartInstance.current = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: colors,
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        });
                    }
                }
            }, [currentPage, filteredTransactions, selectedAccount, settings.monthStartDay, viewMode, periodOffset]);

            // Grafico centrale categorie (stile 1Money)
            useEffect(() => {
                if (currentPage === 'categories') {
                    setTimeout(() => {
                        const canvas = document.getElementById('categoryChart');
                        if (!canvas) return;
                        
                        const ctx = canvas.getContext('2d');
                        
                        // Distruggi grafico precedente se esiste
                        if (window.categoryChartInstance) {
                            window.categoryChartInstance.destroy();
                        }

                        const expensesByCategory = getMonthlyExpensesByCategory();

                        const labels = Object.keys(expensesByCategory).map(catId => {
                            const cat = CATEGORIES.expense.find(c => c.id === catId);
                            return cat ? cat.name : catId;
                        });

                        const data = Object.values(expensesByCategory);
                        const colors = Object.keys(expensesByCategory).map(catId => {
                            const cat = CATEGORIES.expense.find(c => c.id === catId);
                            return cat ? cat.color : '#999';
                        });

                        if (data.length > 0) {
                            window.categoryChartInstance = new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        data: data,
                                        backgroundColor: colors,
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    cutout: '70%',
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            enabled: true
                                        }
                                    }
                                }
                            });
                        }
                    }, 100);
                }
            }, [currentPage, filteredTransactions, selectedAccount, settings.monthStartDay, viewMode, periodOffset]);

            // Grafico trend mensile
            useEffect(() => {
                if (currentPage === 'stats' && trendChartRef.current) {
                    const ctx = trendChartRef.current.getContext('2d');
                    
                    if (trendChartInstance.current) {
                        trendChartInstance.current.destroy();
                    }

                    // Ultimi 6 periodi personalizzati
                    const months = [];
                    const incomeData = [];
                    const expenseData = [];
                    
                    for (let i = 5; i >= 0; i--) {
                        const today = new Date();
                        const startDay = settings.monthStartDay;
                        
                        // Calcola il periodo i mesi fa
                        let periodStart, periodEnd;
                        if (today.getDate() >= startDay) {
                            periodStart = new Date(today.getFullYear(), today.getMonth() - i, startDay);
                            periodEnd = new Date(today.getFullYear(), today.getMonth() - i + 1, startDay - 1);
                        } else {
                            periodStart = new Date(today.getFullYear(), today.getMonth() - i - 1, startDay);
                            periodEnd = new Date(today.getFullYear(), today.getMonth() - i, startDay - 1);
                        }
                        
                        months.push(periodStart.toLocaleDateString('it-IT', { month: 'short', year: '2-digit' }));
                        
                        const periodTransactions = filteredTransactions.filter(t => {
                            const tDate = new Date(t.date);
                            return tDate >= periodStart && tDate <= periodEnd;
                        });
                        
                        const income = periodTransactions
                            .filter(t => t.type === 'income')
                            .reduce((acc, t) => acc + t.amount, 0);
                        
                        const expense = periodTransactions
                            .filter(t => t.type === 'expense')
                            .reduce((acc, t) => acc + t.amount, 0);
                        
                        incomeData.push(income);
                        expenseData.push(expense);
                    }

                    trendChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Entrate',
                                    data: incomeData,
                                    borderColor: '#4CAF50',
                                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Uscite',
                                    data: expenseData,
                                    borderColor: '#f44336',
                                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }, [currentPage, filteredTransactions, settings.monthStartDay, viewMode, periodOffset]);

            return (
                <div className="app-container">
                    <div className="header" style={{ background: getActiveAccount()?.color ? `linear-gradient(135deg, ${getActiveAccount().color} 0%, ${getActiveAccount().color}dd 100%)` : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <select
                                    value={activeAccountId || ''}
                                    onChange={(e) => switchAccount(e.target.value)}
                                    style={{
                                        background: 'rgba(255,255,255,0.95)',
                                        border: 'none',
                                        padding: '8px 12px',
                                        borderRadius: '8px',
                                        fontSize: '16px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        color: getActiveAccount()?.color || '#667eea'
                                    }}
                                >
                                    {accounts.map(acc => (
                                        <option key={acc.id} value={acc.id}>
                                            {acc.icon} {acc.name}
                                        </option>
                                    ))}
                                </select>
                                <button
                                    onClick={() => setShowAccountModal(true)}
                                    style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        border: 'none',
                                        color: 'white',
                                        padding: '6px 12px',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '16px'
                                    }}
                                    title="Nuovo Account"
                                >
                                    âž•
                                </button>
                            </div>
                            <button 
                                onClick={() => setShowSettingsModal(true)}
                                style={{
                                    background: 'rgba(255,255,255,0.2)',
                                    border: 'none',
                                    color: 'white',
                                    padding: '8px 16px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '20px'
                                }}
                            >
                                âš™ï¸
                            </button>
                        </div>
                        <div style={{ marginTop: '10px' }}>
                            <select 
                                value={selectedAccount}
                                onChange={(e) => setSelectedAccount(e.target.value)}
                                style={{
                                    background: 'rgba(255,255,255,0.9)',
                                    border: 'none',
                                    padding: '8px 12px',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    marginRight: '10px'
                                }}
                            >
                                {ACCOUNTS.map(acc => (
                                    <option key={acc.id} value={acc.id}>
                                        {acc.icon} {acc.name}
                                    </option>
                                ))}
                            </select>
                            
                            <select 
                                value={viewMode}
                                onChange={(e) => {
                                    setViewMode(e.target.value);
                                    setPeriodOffset(0);
                                }}
                                style={{
                                    background: 'rgba(255,255,255,0.9)',
                                    border: 'none',
                                    padding: '8px 12px',
                                    borderRadius: '8px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    cursor: 'pointer'
                                }}
                            >
                                <option value="month">ðŸ“… Mese</option>
                                <option value="week">ðŸ“† Settimana</option>
                                <option value="year">ðŸ“Š Anno</option>
                                <option value="custom">ðŸŽ¯ Personalizzato</option>
                            </select>
                            
                            <div style={{ 
                                color: 'rgba(255,255,255,0.9)', 
                                fontSize: '13px', 
                                marginTop: '10px',
                                fontWeight: '500',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '10px'
                            }}>
                                <button
                                    onClick={goToPreviousPeriod}
                                    style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        border: 'none',
                                        color: 'white',
                                        padding: '6px 12px',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '16px'
                                    }}
                                >
                                    â—€
                                </button>
                                
                                <div style={{ 
                                    flex: 1, 
                                    textAlign: 'center',
                                    background: 'rgba(255,255,255,0.2)',
                                    padding: '6px 12px',
                                    borderRadius: '6px'
                                }}>
                                    {formatPeriodDisplay()}
                                </div>
                                
                                <button
                                    onClick={goToNextPeriod}
                                    style={{
                                        background: 'rgba(255,255,255,0.2)',
                                        border: 'none',
                                        color: 'white',
                                        padding: '6px 12px',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '16px'
                                    }}
                                >
                                    â–¶
                                </button>
                                
                                {periodOffset !== 0 && (
                                    <button
                                        onClick={goToCurrentPeriod}
                                        style={{
                                            background: 'rgba(255,255,255,0.9)',
                                            border: 'none',
                                            color: '#667eea',
                                            padding: '6px 12px',
                                            borderRadius: '6px',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        Oggi
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="balance-card">
                        <div className="balance-label">Saldo Totale</div>
                        <div className="balance-amount">â‚¬ {balance.toFixed(2)}</div>
                        <div className="stats-row">
                            <div className="stat-box income">
                                <div className="stat-label">Entrate</div>
                                <div className="stat-value income">â‚¬ {totalIncome.toFixed(2)}</div>
                            </div>
                            <div className="stat-box expense">
                                <div className="stat-label">Uscite</div>
                                <div className="stat-value expense">â‚¬ {totalExpense.toFixed(2)}</div>
                            </div>
                            <div className="stat-box neutral">
                                <div className="stat-label">Affitto</div>
                                <div className="stat-value neutral">â‚¬ {(getMonthlyExpensesByCategory().rent || 0).toFixed(2)}</div>
                            </div>
                            <div className="stat-box neutral">
                                <div className="stat-label">Bollette</div>
                                <div className="stat-value neutral">â‚¬ {(getMonthlyExpensesByCategory().bills || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>

                    {currentPage === 'categories' && (
                        <CategoriesView 
                            expenses={getMonthlyExpensesByCategory()}
                            budgets={budgets}
                            onCategoryClick={handleCategoryClick}
                        />
                    )}

                    {currentPage === 'home' && (
                        <>
                            <div className="tabs">
                                <button 
                                    className={`tab ${activeTab === 'transactions' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('transactions')}
                                >
                                    Transazioni
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'recent' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('recent')}
                                >
                                    Recenti
                                </button>
                            </div>

                            <div className="content">
                                {categoryFilter && (
                                    <div style={{
                                        background: '#e3f2fd',
                                        padding: '12px 16px',
                                        borderRadius: '8px',
                                        marginBottom: '15px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <span style={{ fontSize: '18px', marginRight: '8px' }}>
                                                {CATEGORIES.expense.find(c => c.id === categoryFilter)?.icon}
                                            </span>
                                            <span style={{ fontWeight: 'bold' }}>
                                                Filtro: {CATEGORIES.expense.find(c => c.id === categoryFilter)?.name}
                                            </span>
                                        </div>
                                        <button
                                            onClick={() => setCategoryFilter(null)}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                color: '#1976d2',
                                                cursor: 'pointer',
                                                fontSize: '14px',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            âœ• Rimuovi
                                        </button>
                                    </div>
                                )}

                                <div style={{
                                    display: 'flex',
                                    gap: '10px',
                                    marginBottom: '15px',
                                    alignItems: 'center'
                                }}>
                                    <button
                                        onClick={() => setTransfersOnlyFilter(!transfersOnlyFilter)}
                                        style={{
                                            background: transfersOnlyFilter ? '#FF9800' : '#e0e0e0',
                                            color: transfersOnlyFilter ? 'white' : '#666',
                                            border: 'none',
                                            padding: '8px 16px',
                                            borderRadius: '20px',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: 'bold',
                                            transition: 'all 0.3s'
                                        }}
                                    >
                                        ðŸ”„ {transfersOnlyFilter ? 'Mostra tutti' : 'Solo trasferimenti'}
                                    </button>
                                    {transfersOnlyFilter && (
                                        <span style={{ fontSize: '12px', color: '#666' }}>
                                            {filteredTransactions.filter(t => t.isTransfer).length} trasferimenti
                                        </span>
                                    )}
                                </div>
                                
                                {(() => {
                                    let displayTransactions = filteredTransactions;
                                    if (categoryFilter) displayTransactions = displayTransactions.filter(t => t.category === categoryFilter);
                                    if (transfersOnlyFilter) displayTransactions = displayTransactions.filter(t => t.isTransfer);
                                    
                                    return displayTransactions.length === 0 ? (
                                        <div className="empty-state">
                                            <div className="empty-icon">ðŸ“Š</div>
                                            <h3>Nessuna transazione</h3>
                                            <p>{categoryFilter ? 'Nessuna transazione per questa categoria' : transfersOnlyFilter ? 'Nessun trasferimento trovato' : 'Inizia ad aggiungere le tue spese e entrate!'}</p>
                                        </div>
                                    ) : (
                                        <TransactionList 
                                            transactions={displayTransactions} 
                                            onDelete={deleteTransaction}
                                        />
                                    );
                                })()}
                            </div>
                        </>
                    )}

                    {currentPage === 'budget' && (
                        <BudgetPage 
                            budgets={budgets}
                            expenses={getMonthlyExpensesByCategory()}
                            onSetBudget={setBudget}
                            onOpenModal={() => setShowBudgetModal(true)}
                        />
                    )}

                    {currentPage === 'stats' && (
                        <div className="content">
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                                <h2>Statistiche</h2>
                                <button 
                                    onClick={exportToExcel}
                                    style={{
                                        padding: '10px 20px',
                                        background: '#4CAF50',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    ðŸ“Š Esporta Excel
                                </button>
                            </div>
                            
                            {transactions.length > 0 ? (
                                <>
                                    <div className="chart-container">
                                        <h3>Trend Ultimi 6 Mesi</h3>
                                        <canvas ref={trendChartRef}></canvas>
                                    </div>
                                    
                                    {Object.keys(getMonthlyExpensesByCategory()).length > 0 && (
                                        <div className="chart-container">
                                            <h3>Spese per Categoria (Questo Mese)</h3>
                                            <canvas ref={chartRef}></canvas>
                                        </div>
                                    )}
                                    
                                    <MonthlyStats transactions={getCurrentMonthTransactions()} />
                                </>
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-icon">ðŸ“ˆ</div>
                                    <h3>Nessun dato</h3>
                                    <p>Aggiungi alcune transazioni per vedere le statistiche</p>
                                </div>
                            )}
                        </div>
                    )}

                    <button className="fab" onClick={() => setShowModal(true)}>
                        +
                    </button>

                    {accounts.length > 1 && (
                        <button 
                            className="fab" 
                            onClick={() => setShowTransferModal(true)}
                            style={{ 
                                right: '90px',
                                background: 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'
                            }}
                            title="Trasferimento tra Account"
                        >
                            ðŸ”„
                        </button>
                    )}

                    {showModal && (
                        <AddTransactionModal 
                            onClose={() => setShowModal(false)}
                            onAdd={addTransaction}
                            preselectedCategory={typeof showModal === 'object' ? showModal.preselectedCategory : null}
                        />
                    )}

                    {showCategoryMenu && (
                        <CategoryContextMenu
                            category={showCategoryMenu.category}
                            x={showCategoryMenu.x}
                            y={showCategoryMenu.y}
                            onClose={() => setShowCategoryMenu(null)}
                            onAddMovement={() => handleAddMovementFromCategory(showCategoryMenu.categoryId)}
                            onViewMovements={() => handleViewMovements(showCategoryMenu.categoryId)}
                            onEditCategory={() => handleEditCategory(showCategoryMenu.categoryId)}
                        />
                    )}

                    {showEditCategoryModal && (
                        <EditCategoryModal
                            category={CATEGORIES.expense.find(c => c.id === showEditCategoryModal)}
                            onClose={() => setShowEditCategoryModal(null)}
                            onSave={(newData) => updateCategory(showEditCategoryModal, newData)}
                        />
                    )}

                    {showBudgetModal && (
                        <SetBudgetModal 
                            onClose={() => setShowBudgetModal(false)}
                            budgets={budgets}
                            onSetBudget={setBudget}
                        />
                    )}

                    {showAccountModal && (
                        <AccountModal
                            onClose={() => setShowAccountModal(false)}
                            onCreate={createAccount}
                            accounts={accounts}
                        />
                    )}

                    {showTransferModal && (
                        <TransferModal
                            onClose={() => setShowTransferModal(false)}
                            onTransfer={createTransfer}
                            accounts={accounts}
                            activeAccountId={activeAccountId}
                        />
                    )}

                    {showSettingsModal && (
                        <SettingsModal 
                            onClose={() => setShowSettingsModal(false)}
                            settings={settings}
                            onSave={updateSettings}
                            handleFileUpload={handleFileUpload}
                            accounts={accounts}
                            activeAccountId={activeAccountId}
                            getActiveAccount={getActiveAccount}
                            deleteAccount={deleteAccount}
                        />
                    )}

                    <div className="bottom-nav">
                        <button 
                            className={`nav-item ${currentPage === 'categories' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('categories')}
                        >
                            <div className="nav-icon">ðŸ“Š</div>
                            <div className="nav-label">Categorie</div>
                        </button>
                        <button 
                            className={`nav-item ${currentPage === 'home' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('home')}
                        >
                            <div className="nav-icon">ðŸ“</div>
                            <div className="nav-label">Movimenti</div>
                        </button>
                        <button 
                            className={`nav-item ${currentPage === 'budget' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('budget')}
                        >
                            <div className="nav-icon">ðŸ’°</div>
                            <div className="nav-label">Budget</div>
                        </button>
                        <button 
                            className={`nav-item ${currentPage === 'stats' ? 'active' : ''}`}
                            onClick={() => setCurrentPage('stats')}
                        >
                            <div className="nav-icon">ðŸ“ˆ</div>
                            <div className="nav-label">Riepilogo</div>
                        </button>
                    </div>
                </div>
            );
        }

        function TransactionList({ transactions, onDelete }) {
            const getCategoryInfo = (type, categoryId) => {
                const cat = CATEGORIES[type].find(c => c.id === categoryId);
                return cat || { name: categoryId, icon: 'â“', color: '#999' };
            };

            const getAccountInfo = (accountId) => {
                const acc = ACCOUNTS.find(a => a.id === accountId);
                return acc || { name: 'Sconosciuto', icon: 'â“' };
            };

            return (
                <ul className="transaction-list">
                    {transactions.map(transaction => {
                        const category = getCategoryInfo(transaction.type, transaction.category);
                        const account = getAccountInfo(transaction.account || 'cash');
                        return (
                            <li key={transaction.id} className="transaction-item">
                                <div style={{ display: 'flex', alignItems: 'center', flex: 1 }}>
                                    <div 
                                        className="transaction-icon"
                                        style={{ backgroundColor: category.color + '20' }}
                                    >
                                        {category.icon}
                                    </div>
                                    <div className="transaction-info">
                                        <div className="transaction-category">{category.name}</div>
                                        <div className="transaction-date">
                                            {new Date(transaction.date).toLocaleDateString('it-IT')} â€¢ {account.icon} {account.name}
                                        </div>
                                        {transaction.note && (
                                            <div className="transaction-date">{transaction.note}</div>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <div className={`transaction-amount ${transaction.type}`}>
                                        {transaction.type === 'income' ? '+' : '-'}â‚¬ {transaction.amount.toFixed(2)}
                                    </div>
                                    <button 
                                        onClick={() => onDelete(transaction.id)}
                                        style={{
                                            background: 'none',
                                            border: 'none',
                                            color: '#f44336',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            marginTop: '5px'
                                        }}
                                    >
                                        Elimina
                                    </button>
                                </div>
                            </li>
                        );
                    })}
                </ul>
            );
        }

        function AddTransactionModal({ onClose, onAdd, preselectedCategory }) {
            const [type, setType] = useState('expense');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState(preselectedCategory || '');
            const [account, setAccount] = useState('cash');
            const [note, setNote] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || !category) return;

                const transaction = {
                    id: Date.now(),
                    type,
                    amount: parseFloat(amount),
                    category,
                    account,
                    note,
                    date: new Date(date).toISOString()
                };

                onAdd(transaction);
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Nuova Transazione</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div className="type-selector">
                                <button 
                                    type="button"
                                    className={`type-btn expense ${type === 'expense' ? 'active' : ''}`}
                                    onClick={() => { setType('expense'); setCategory(''); }}
                                >
                                    Uscita
                                </button>
                                <button 
                                    type="button"
                                    className={`type-btn income ${type === 'income' ? 'active' : ''}`}
                                    onClick={() => { setType('income'); setCategory(''); }}
                                >
                                    Entrata
                                </button>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Importo (â‚¬)</label>
                                <input 
                                    type="number" 
                                    step="0.01"
                                    className="form-input"
                                    value={amount}
                                    onChange={e => setAmount(e.target.value)}
                                    placeholder="0.00"
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Conto</label>
                                <select 
                                    className="form-input"
                                    value={account}
                                    onChange={e => setAccount(e.target.value)}
                                    required
                                >
                                    {ACCOUNTS.filter(a => a.id !== 'all').map(acc => (
                                        <option key={acc.id} value={acc.id}>
                                            {acc.icon} {acc.name}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Categoria</label>
                                <div className="category-grid">
                                    {CATEGORIES[type].map(cat => (
                                        <button
                                            key={cat.id}
                                            type="button"
                                            className={`category-btn ${category === cat.id ? 'active' : ''}`}
                                            onClick={() => setCategory(cat.id)}
                                        >
                                            <div className="category-icon">{cat.icon}</div>
                                            <div className="category-name">{cat.name}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Data</label>
                                <input 
                                    type="date"
                                    className="form-input"
                                    value={date}
                                    onChange={e => setDate(e.target.value)}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Note (opzionale)</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={note}
                                    onChange={e => setNote(e.target.value)}
                                    placeholder="Aggiungi una nota..."
                                />
                            </div>

                            <button type="submit" className="submit-btn">
                                Aggiungi Transazione
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function CategoriesView({ expenses, budgets, onCategoryClick }) {
            const [categoryOrder, setCategoryOrder] = React.useState([]);
            const [draggedItem, setDraggedItem] = React.useState(null);
            
            // Inizializza ordine categorie
            React.useEffect(() => {
                const savedOrder = localStorage.getItem('categoryOrder');
                if (savedOrder) {
                    setCategoryOrder(JSON.parse(savedOrder));
                } else {
                    setCategoryOrder(CATEGORIES.expense.map(c => c.id));
                }
            }, []);
            
            // Salva ordine
            React.useEffect(() => {
                if (categoryOrder.length > 0) {
                    localStorage.setItem('categoryOrder', JSON.stringify(categoryOrder));
                }
            }, [categoryOrder]);
            
            const monthlyExpenses = expenses;
            const totalExpense = Object.values(monthlyExpenses).reduce((acc, val) => acc + val, 0);
            const totalBudget = Object.values(budgets).reduce((acc, val) => acc + val, 0);
            
            // Ottieni categorie nell'ordine salvato
            const orderedCategories = categoryOrder
                .map(id => CATEGORIES.expense.find(c => c.id === id))
                .filter(Boolean);
            
            // Aggiungi eventuali nuove categorie non nell'ordine
            CATEGORIES.expense.forEach(cat => {
                if (!categoryOrder.includes(cat.id)) {
                    orderedCategories.push(cat);
                }
            });
            
            const handleDragStart = (e, categoryId) => {
                setDraggedItem(categoryId);
                e.dataTransfer.effectAllowed = 'move';
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };
            
            const handleDrop = (e, targetId) => {
                e.preventDefault();
                if (draggedItem === targetId) return;
                
                const newOrder = [...categoryOrder];
                const draggedIndex = newOrder.indexOf(draggedItem);
                const targetIndex = newOrder.indexOf(targetId);
                
                // Rimuovi elemento dalla posizione originale
                newOrder.splice(draggedIndex, 1);
                // Inserisci nella nuova posizione
                newOrder.splice(targetIndex, 0, draggedItem);
                
                setCategoryOrder(newOrder);
                setDraggedItem(null);
            };
            
            return (
                <div className="dashboard-container">
                    {/* Grafico centrale con info */}
                    <div className="chart-center-container">
                        <canvas id="categoryChart" style={{ maxHeight: '280px' }}></canvas>
                        <div className="chart-center-info">
                            <div className="chart-center-label">Spese</div>
                            <div className="chart-center-amount">{totalExpense.toFixed(2)} â‚¬</div>
                            <div className="chart-center-budget">{totalBudget.toFixed(0)} â‚¬</div>
                        </div>
                    </div>
                    
                    {/* Grid categorie - TUTTE con stesso stile */}
                    <div className="categories-grid">
                        {orderedCategories.map(category => {
                            const amount = monthlyExpenses[category.id] || 0;
                            const budget = budgets[category.id] || 0;
                            const exceeded = budget > 0 && amount > budget;
                            const remaining = budget - amount;
                            
                            return (
                                <div 
                                    key={category.id} 
                                    className="category-card"
                                    draggable="true"
                                    onDragStart={(e) => handleDragStart(e, category.id)}
                                    onDragOver={handleDragOver}
                                    onDrop={(e) => handleDrop(e, category.id)}
                                    onClick={(e) => onCategoryClick && onCategoryClick(category, e)}
                                    style={{
                                        opacity: draggedItem === category.id ? 0.5 : 1,
                                        cursor: 'move'
                                    }}
                                >
                                    <div 
                                        className="category-circle"
                                        style={{ background: category.color }}
                                    >
                                        {category.icon}
                                    </div>
                                    <div className="category-amount" style={{ color: exceeded ? '#f44336' : category.color }}>
                                        {amount.toFixed(0)} â‚¬
                                    </div>
                                    <div className="category-name-small">{category.name}</div>
                                    {budget > 0 && (
                                        <div style={{ 
                                            fontSize: exceeded ? '10px' : '9px', 
                                            color: exceeded ? '#f44336' : '#999',
                                            fontWeight: exceeded ? 'bold' : 'normal',
                                            marginTop: '2px'
                                        }}>
                                            {exceeded ? (
                                                <span style={{ color: '#f44336', fontWeight: 'bold' }}>
                                                    +{Math.abs(remaining).toFixed(0)} â‚¬
                                                </span>
                                            ) : (
                                                <span>{budget.toFixed(0)} â‚¬</span>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    <div style={{
                        textAlign: 'center',
                        fontSize: '11px',
                        color: '#999',
                        marginTop: '15px',
                        padding: '10px'
                    }}>
                        ðŸ’¡ Tieni premuto e trascina per riordinare le categorie
                    </div>
                </div>
            );
        }

        function CategoryContextMenu({ category, x, y, onClose, onAddMovement, onViewMovements, onEditCategory }) {
            React.useEffect(() => {
                const handleClickOutside = () => onClose();
                setTimeout(() => document.addEventListener('click', handleClickOutside), 0);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            return (
                <div 
                    style={{
                        position: 'fixed',
                        top: y + 'px',
                        left: x + 'px',
                        transform: 'translateX(-50%)',
                        background: 'white',
                        borderRadius: '12px',
                        boxShadow: '0 4px 20px rgba(0,0,0,0.25)',
                        zIndex: 10000,
                        minWidth: '200px',
                        overflow: 'hidden',
                        animation: 'menuAppear 0.2s ease-out'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    <div style={{
                        padding: '12px 16px',
                        borderBottom: '1px solid #f0f0f0',
                        background: category.color + '20',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px'
                    }}>
                        <span style={{ fontSize: '24px' }}>{category.icon}</span>
                        <span style={{ fontWeight: 'bold', color: category.color }}>{category.name}</span>
                    </div>
                    
                    <div style={{ padding: '8px 0' }}>
                        <button
                            onClick={onAddMovement}
                            style={{
                                width: '100%',
                                padding: '12px 16px',
                                border: 'none',
                                background: 'none',
                                textAlign: 'left',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                fontSize: '14px',
                                transition: 'background 0.2s'
                            }}
                            onMouseOver={(e) => e.currentTarget.style.background = '#f5f5f5'}
                            onMouseOut={(e) => e.currentTarget.style.background = 'none'}
                        >
                            <span style={{ fontSize: '18px' }}>âž•</span>
                            <span>Aggiungi movimento</span>
                        </button>
                        
                        <button
                            onClick={onViewMovements}
                            style={{
                                width: '100%',
                                padding: '12px 16px',
                                border: 'none',
                                background: 'none',
                                textAlign: 'left',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                fontSize: '14px',
                                transition: 'background 0.2s'
                            }}
                            onMouseOver={(e) => e.currentTarget.style.background = '#f5f5f5'}
                            onMouseOut={(e) => e.currentTarget.style.background = 'none'}
                        >
                            <span style={{ fontSize: '18px' }}>ðŸ“‹</span>
                            <span>Vedi movimenti</span>
                        </button>
                        
                        <button
                            onClick={onEditCategory}
                            style={{
                                width: '100%',
                                padding: '12px 16px',
                                border: 'none',
                                background: 'none',
                                textAlign: 'left',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                fontSize: '14px',
                                transition: 'background 0.2s'
                            }}
                            onMouseOver={(e) => e.currentTarget.style.background = '#f5f5f5'}
                            onMouseOut={(e) => e.currentTarget.style.background = 'none'}
                        >
                            <span style={{ fontSize: '18px' }}>âœï¸</span>
                            <span>Modifica categoria</span>
                        </button>
                    </div>
                </div>
            );
        }

        function EditCategoryModal({ category, onClose, onSave }) {
            const [name, setName] = React.useState(category.name);
            const [icon, setIcon] = React.useState(category.icon);
            const [color, setColor] = React.useState(category.color);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ name, icon, color });
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">âœï¸ Modifica Categoria</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Nome</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={name}
                                    onChange={e => setName(e.target.value)}
                                    placeholder="Nome categoria"
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Icona (Emoji)</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={icon}
                                    onChange={e => setIcon(e.target.value)}
                                    placeholder="ðŸ›’"
                                    maxLength="2"
                                    style={{ fontSize: '24px', textAlign: 'center' }}
                                    required
                                />
                                <div style={{ fontSize: '11px', color: '#999', marginTop: '5px' }}>
                                    Incolla un'emoji da usare come icona
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Colore</label>
                                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                    <input 
                                        type="color"
                                        value={color}
                                        onChange={e => setColor(e.target.value)}
                                        style={{
                                            width: '60px',
                                            height: '40px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '8px',
                                            cursor: 'pointer'
                                        }}
                                    />
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={color}
                                        onChange={e => setColor(e.target.value)}
                                        placeholder="#FF6B6B"
                                        style={{ flex: 1 }}
                                    />
                                </div>
                            </div>

                            <div style={{
                                padding: '20px',
                                background: color + '20',
                                borderRadius: '12px',
                                marginBottom: '20px',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '11px', color: '#666', marginBottom: '10px' }}>
                                    Anteprima:
                                </div>
                                <div
                                    style={{
                                        width: '60px',
                                        height: '60px',
                                        borderRadius: '50%',
                                        background: color,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '28px',
                                        margin: '0 auto 10px',
                                        boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                                    }}
                                >
                                    {icon}
                                </div>
                                <div style={{ fontWeight: 'bold', color: color }}>
                                    {name}
                                </div>
                            </div>

                            <button type="submit" className="submit-btn">
                                ðŸ’¾ Salva Modifiche
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ============ ACCOUNT MODAL ============
        function AccountModal({ onClose, onCreate, accounts }) {
            const [name, setName] = React.useState('');
            const [icon, setIcon] = React.useState('ðŸ’¼');
            const [color, setColor] = React.useState('#2196F3');

            const handleSubmit = (e) => {
                e.preventDefault();
                onCreate({ name, icon, color });
                onClose();
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">âž• Nuovo Account</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Nome Account</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={name}
                                    onChange={e => setName(e.target.value)}
                                    placeholder="es: Spese Casa, Progetti..."
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Icona (Emoji)</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={icon}
                                    onChange={e => setIcon(e.target.value)}
                                    placeholder="ðŸ’¼"
                                    maxLength="2"
                                    style={{ fontSize: '24px', textAlign: 'center' }}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Colore</label>
                                <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                                    <input 
                                        type="color"
                                        value={color}
                                        onChange={e => setColor(e.target.value)}
                                        style={{
                                            width: '60px',
                                            height: '40px',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '8px',
                                            cursor: 'pointer'
                                        }}
                                    />
                                    <input 
                                        type="text"
                                        className="form-input"
                                        value={color}
                                        onChange={e => setColor(e.target.value)}
                                        placeholder="#2196F3"
                                        style={{ flex: 1 }}
                                    />
                                </div>
                            </div>

                            <button type="submit" className="submit-btn">
                                âœ… Crea Account
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ============ TRANSFER MODAL ============
        function TransferModal({ onClose, onTransfer, accounts, activeAccountId }) {
            const [targetAccountId, setTargetAccountId] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const [fromAccountType, setFromAccountType] = React.useState('cash');
            const [toAccountType, setToAccountType] = React.useState('cash');
            const [note, setNote] = React.useState('');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);

            const otherAccounts = accounts.filter(a => a.id !== activeAccountId);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!targetAccountId || !amount) return;

                onTransfer({
                    fromAccountId: activeAccountId,
                    toAccountId: targetAccountId,
                    amount: parseFloat(amount),
                    fromAccountType,
                    toAccountType,
                    note,
                    date: new Date(date).toISOString()
                });
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">ðŸ”„ Trasferimento tra Account</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{
                                background: '#e3f2fd',
                                padding: '12px',
                                borderRadius: '8px',
                                marginBottom: '20px',
                                fontSize: '14px'
                            }}>
                                <strong>Da:</strong> {accounts.find(a => a.id === activeAccountId)?.icon} {accounts.find(a => a.id === activeAccountId)?.name}
                            </div>

                            <div className="form-group">
                                <label className="form-label">A Account</label>
                                <select 
                                    className="form-input"
                                    value={targetAccountId}
                                    onChange={e => setTargetAccountId(e.target.value)}
                                    required
                                >
                                    <option value="">Seleziona account destinazione</option>
                                    {otherAccounts.map(acc => (
                                        <option key={acc.id} value={acc.id}>
                                            {acc.icon} {acc.name}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Importo (â‚¬)</label>
                                <input 
                                    type="number" 
                                    step="0.01"
                                    className="form-input"
                                    value={amount}
                                    onChange={e => setAmount(e.target.value)}
                                    placeholder="0.00"
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Dal Conto</label>
                                <select 
                                    className="form-input"
                                    value={fromAccountType}
                                    onChange={e => setFromAccountType(e.target.value)}
                                >
                                    {ACCOUNTS.filter(a => a.id !== 'all').map(acc => (
                                        <option key={acc.id} value={acc.id}>
                                            {acc.icon} {acc.name}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Al Conto</label>
                                <select 
                                    className="form-input"
                                    value={toAccountType}
                                    onChange={e => setToAccountType(e.target.value)}
                                >
                                    {ACCOUNTS.filter(a => a.id !== 'all').map(acc => (
                                        <option key={acc.id} value={acc.id}>
                                            {acc.icon} {acc.name}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Data</label>
                                <input 
                                    type="date"
                                    className="form-input"
                                    value={date}
                                    onChange={e => setDate(e.target.value)}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Note (opzionale)</label>
                                <input 
                                    type="text"
                                    className="form-input"
                                    value={note}
                                    onChange={e => setNote(e.target.value)}
                                    placeholder="Motivo trasferimento..."
                                />
                            </div>

                            <button type="submit" className="submit-btn">
                                ðŸ”„ Esegui Trasferimento
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function BudgetPage({ budgets, expenses, onSetBudget, onOpenModal }) {
            return (
                <div className="content">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                        <h2>Budget Mensile</h2>
                        <button 
                            onClick={onOpenModal}
                            style={{
                                padding: '10px 20px',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontWeight: 'bold'
                            }}
                        >
                            + Imposta Budget
                        </button>
                    </div>

                    {Object.keys(budgets).length === 0 ? (
                        <div className="empty-state">
                            <div className="empty-icon">ðŸ’°</div>
                            <h3>Nessun Budget Impostato</h3>
                            <p>Imposta i budget per le tue categorie di spesa</p>
                        </div>
                    ) : (
                        <div>
                            {CATEGORIES.expense.map(category => {
                                const budget = budgets[category.id] || 0;
                                const spent = expenses[category.id] || 0;
                                const percentage = budget > 0 ? (spent / budget) * 100 : 0;
                                const isOverBudget = spent > budget;

                                if (budget === 0) return null;

                                return (
                                    <div key={category.id} style={{
                                        background: 'white',
                                        padding: '20px',
                                        borderRadius: '15px',
                                        marginBottom: '15px',
                                        boxShadow: '0 2px 5px rgba(0,0,0,0.05)'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                                <span style={{ fontSize: '24px' }}>{category.icon}</span>
                                                <span style={{ fontWeight: 'bold' }}>{category.name}</span>
                                            </div>
                                            <span style={{ 
                                                fontWeight: 'bold',
                                                color: isOverBudget ? '#f44336' : '#4CAF50'
                                            }}>
                                                â‚¬{spent.toFixed(2)} / â‚¬{budget.toFixed(2)}
                                            </span>
                                        </div>
                                        
                                        <div style={{
                                            width: '100%',
                                            height: '10px',
                                            background: '#f0f0f0',
                                            borderRadius: '5px',
                                            overflow: 'hidden'
                                        }}>
                                            <div style={{
                                                width: `${Math.min(percentage, 100)}%`,
                                                height: '100%',
                                                background: isOverBudget ? 
                                                    'linear-gradient(90deg, #f44336 0%, #e91e63 100%)' : 
                                                    'linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%)',
                                                transition: 'width 0.3s ease'
                                            }}></div>
                                        </div>
                                        
                                        <div style={{ 
                                            marginTop: '5px', 
                                            fontSize: '12px', 
                                            color: isOverBudget ? '#f44336' : '#666',
                                            textAlign: 'right'
                                        }}>
                                            {isOverBudget ? 
                                                `Superato di â‚¬${(spent - budget).toFixed(2)}` :
                                                `Rimanente: â‚¬${(budget - spent).toFixed(2)}`
                                            }
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function SetBudgetModal({ onClose, budgets, onSetBudget }) {
            const [amounts, setAmounts] = useState({});

            useEffect(() => {
                setAmounts(budgets);
            }, [budgets]);

            const handleSubmit = (e) => {
                e.preventDefault();
                Object.keys(amounts).forEach(categoryId => {
                    if (amounts[categoryId]) {
                        onSetBudget(categoryId, amounts[categoryId]);
                    }
                });
                onClose();
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Imposta Budget Mensili</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            {CATEGORIES.expense.map(category => (
                                <div key={category.id} className="form-group">
                                    <label className="form-label">
                                        <span style={{ fontSize: '20px', marginRight: '8px' }}>{category.icon}</span>
                                        {category.name}
                                    </label>
                                    <input 
                                        type="number"
                                        step="0.01"
                                        className="form-input"
                                        value={amounts[category.id] || ''}
                                        onChange={e => setAmounts({...amounts, [category.id]: e.target.value})}
                                        placeholder="0.00"
                                    />
                                </div>
                            ))}

                            <button type="submit" className="submit-btn">
                                Salva Budget
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function SettingsModal({ onClose, settings, onSave, handleFileUpload, accounts, activeAccountId, getActiveAccount, deleteAccount }) {
            const [monthStartDay, setMonthStartDay] = useState(settings.monthStartDay);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ monthStartDay: parseInt(monthStartDay) });
            };

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">âš™ï¸ Impostazioni</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{ 
                                padding: '15px', 
                                background: '#f3e5f5', 
                                borderRadius: '10px',
                                marginBottom: '20px'
                            }}>
                                <div style={{ fontWeight: 'bold', marginBottom: '10px', color: '#7b1fa2' }}>
                                    ðŸ‘¥ Gestione Account
                                </div>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '10px' }}>
                                    Account corrente: <strong>{getActiveAccount()?.icon} {getActiveAccount()?.name}</strong>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                    {accounts.map(acc => (
                                        <div key={acc.id} style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            padding: '8px',
                                            background: acc.id === activeAccountId ? acc.color + '20' : '#fff',
                                            borderRadius: '6px',
                                            border: acc.id === activeAccountId ? `2px solid ${acc.color}` : '1px solid #e0e0e0'
                                        }}>
                                            <span>
                                                {acc.icon} {acc.name}
                                                {acc.id === activeAccountId && ' âœ“'}
                                            </span>
                                            {accounts.length > 1 && (
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        if (window.confirm(`Eliminare "${acc.name}"?\nTutti i dati verranno cancellati!`)) {
                                                            deleteAccount(acc.id);
                                                        }
                                                    }}
                                                    style={{
                                                        background: 'none',
                                                        border: 'none',
                                                        color: '#f44336',
                                                        cursor: 'pointer',
                                                        fontSize: '18px',
                                                        padding: '0 8px'
                                                    }}
                                                >
                                                    ðŸ—‘ï¸
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="form-group">
                                <label className="form-label">
                                    ðŸ“… Il mese inizia dal giorno
                                </label>
                                <select 
                                    className="form-input"
                                    value={monthStartDay}
                                    onChange={e => setMonthStartDay(e.target.value)}
                                >
                                    {Array.from({length: 28}, (_, i) => i + 1).map(day => (
                                        <option key={day} value={day}>
                                            {day}
                                        </option>
                                    ))}
                                </select>
                                <div style={{ fontSize: '12px', color: '#666', marginTop: '8px' }}>
                                    Esempio: Se selezioni "10", il mese sarÃ  dal 10 al 9 del mese successivo
                                </div>
                            </div>

                            <div style={{ 
                                padding: '15px', 
                                background: '#e3f2fd', 
                                borderRadius: '10px',
                                marginBottom: '20px'
                            }}>
                                <div style={{ fontWeight: 'bold', marginBottom: '8px', color: '#1976d2' }}>
                                    ðŸ“Š Periodo Attuale:
                                </div>
                                <div style={{ fontSize: '14px', color: '#555' }}>
                                    Dal {(() => {
                                        const today = new Date();
                                        const startDay = parseInt(monthStartDay);
                                        let startDate, endDate;
                                        
                                        if (today.getDate() >= startDay) {
                                            startDate = new Date(today.getFullYear(), today.getMonth(), startDay);
                                            endDate = new Date(today.getFullYear(), today.getMonth() + 1, startDay - 1);
                                        } else {
                                            startDate = new Date(today.getFullYear(), today.getMonth() - 1, startDay);
                                            endDate = new Date(today.getFullYear(), today.getMonth(), startDay - 1);
                                        }
                                        
                                        return `${startDate.toLocaleDateString('it-IT')} al ${endDate.toLocaleDateString('it-IT')}`;
                                    })()}
                                </div>
                            </div>

                            <div style={{ 
                                padding: '15px', 
                                background: '#f3e5f5', 
                                borderRadius: '10px',
                                marginBottom: '20px'
                            }}>
                                <div style={{ fontSize: '12px', color: '#666' }}>
                                    â„¹ï¸ <strong>Nota:</strong> La settimana inizia sempre dal <strong>LunedÃ¬</strong> come da standard italiano.
                                </div>
                            </div>

                            <div style={{ 
                                padding: '15px', 
                                background: '#e8f5e9', 
                                borderRadius: '10px',
                                marginBottom: '20px'
                            }}>
                                <div style={{ fontWeight: 'bold', marginBottom: '10px', color: '#2e7d32' }}>
                                    ðŸ“¥ Importa da 1Money
                                </div>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '10px' }}>
                                    Carica il file CSV esportato da 1Money per importare tutte le tue transazioni, categorie e conti automaticamente.
                                </div>
                                <input 
                                    type="file" 
                                    accept=".csv"
                                    onChange={handleFileUpload}
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        border: '2px dashed #4CAF50',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        background: 'white'
                                    }}
                                />
                                <div style={{ fontSize: '11px', color: '#999', marginTop: '8px' }}>
                                    âš ï¸ Nota: I trasferimenti tra conti verranno saltati. Le sottocategorie saranno salvate nelle note.
                                </div>
                            </div>

                            <button type="submit" className="submit-btn">
                                ðŸ’¾ Salva Impostazioni
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function MonthlyStats({ transactions }) {
            const income = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const balance = income - expense;
            const savingsRate = income > 0 ? ((income - expense) / income * 100) : 0;

            return (
                <div className="chart-container">
                    <h3>Riepilogo Mensile</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '15px', marginTop: '15px' }}>
                        <div style={{ textAlign: 'center', padding: '15px', background: '#e8f5e9', borderRadius: '10px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>Entrate</div>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#4CAF50' }}>â‚¬{income.toFixed(2)}</div>
                        </div>
                        <div style={{ textAlign: 'center', padding: '15px', background: '#ffebee', borderRadius: '10px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>Uscite</div>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#f44336' }}>â‚¬{expense.toFixed(2)}</div>
                        </div>
                        <div style={{ textAlign: 'center', padding: '15px', background: '#e3f2fd', borderRadius: '10px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>Saldo Mese</div>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: balance >= 0 ? '#4CAF50' : '#f44336' }}>
                                â‚¬{balance.toFixed(2)}
                            </div>
                        </div>
                        <div style={{ textAlign: 'center', padding: '15px', background: '#f3e5f5', borderRadius: '10px' }}>
                            <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>Tasso Risparmio</div>
                            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#9C27B0' }}>
                                {savingsRate.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                    <div style={{ marginTop: '15px', padding: '15px', background: '#fff3e0', borderRadius: '10px' }}>
                        <div style={{ fontSize: '12px', color: '#666', marginBottom: '5px' }}>NÂ° Transazioni</div>
                        <div style={{ fontSize: '18px', fontWeight: 'bold' }}>
                            {transactions.length} transazioni questo mese
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>